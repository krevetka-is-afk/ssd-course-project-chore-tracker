# ADR-002: Standardized error payloads (RFC 7807)

Дата: 2025-10-23
Статус: Accepted

## Context

API должен возвращать структурированные ошибки, чтобы фронт и автоматические системы (SRE, мониторинг) могли надёжно
парсить и агрегировать ошибки. Текущий проект возвращает разнородные JSON/строки.

## Decision

- Ввести глобальный helper `problem()` (RFC7807) с полями `type`, `title`, `status`, `detail`, `correlation_id`.
- Не включать stack traces или внутренние SQL/HTTP детали в `detail` в production; логировать подробности сервер-side
  вместе с `correlation_id`.
- Все исключения в FastAPI перехватываются, переводятся в `problem()`.

## Alternatives

- Использовать готовые библиотеки (например `starlette` ProblemDetails) — хорошо, но даёт меньше контроля над
  correlation_id и маскированием. Отложено.

## Consequences

- \+ Упрощает интеграцию с фронтом и SRE.
- \+ Позволяет привязать лог-строку по `correlation_id`.
- \- Нужна дисциплина: не включать секреты в `detail`.

## Security impact

- Уменьшает вероятность информации-утечки (no tracebacks in body). Связь с NFR-03 (error format) и Threat Model R5 (info
  leak).

## Links

- tests/test_errors.py::test_rfc7807_contract
