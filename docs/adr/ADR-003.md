# ADR-003: Input validation and safe file uploads

Дата: 2025-10-23
Статус: Accepted

## Context

Сервис "Roommate Chores" принимает пользовательские изображения (аватарки/фотографии для задач) и другие файлы в
ограниченных эндпойнтах. Неправильная обработка файлов приводит к RCE, DOS (очень большие файлы), path-traversal,
disclosure через метаданные и TOCTOU (симлинки).

## Decision

1. Обрабатывать содержимое файла (magic bytes) — не доверять только Content-Type/расширению.
2. Вводные лимиты: `MAX_BYTES = 5_000_000` (configurable).
3. Генерировать имя файла как UUID + корректное расширение, никогда не сохранять пользовательскую часть имени.
4. Канонизация пути и проверка, что итоговый путь находится внутри `UPLOAD_ROOT.resolve()`; запрет на симлинки в
   родительских директориях (проверка `is_symlink()` на каждом сегменте пути при записи).
5. Не хранить паролей/ключей в конфиге; использовать `app.config` abstraction (env / Vault mock).
6. Проверять и отвергать опасные типы (например script/zip), разрешая только заранее определённые `image/png`,
   `image/jpeg`.

Пороговые параметры и конфиг вынесены в `src/app/config.py` и доступны через DI.

## Alternatives

- Использовать внешнюю библиотеку типа `python-magic` для распознавания типов. (+ точнее) / (- дополнительная
  зависимость, нативные двоичные зависимости). Мы выбираем в пользу простого `magic bytes` sniffing для PNG/JPEG, с
  extension points для расширения.
- Сохранение оригинальных имён + белый-лист символов. (+ UX) / (- риск collisions & traversal). Решили генерировать
  UUID.

## Consequences

- Плюсы: значительно снижается риск path traversal, large-file DOS, upload of executable files.
- Минусы: ограниченная поддержка форматов сейчас; необходимость расширения, если понадобятся GIF/WebP.
- DX: пользователи не увидят свои имена файлов — нужно document user-facing mapping.

## Rollout plan

- Feature-flag (example `UPLOAD_SAFE`), включить тесты и canary → global.

## Links

- NFR-01 (input validation), NFR-03 (error format RFC7807), F1 from P04.
- tests: `tests/test_uploads.py::test_rejects_big_file`.
