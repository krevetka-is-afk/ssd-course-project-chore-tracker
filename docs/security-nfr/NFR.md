# NFR.md — Таблица требований безопасности

| ID     | Название                           | Описание (кратко)                                                               | Метрика / Порог (измеримо)                                                             | Проверка (чем/где)                                                                  | Компонент       | Приоритет |
|--------|------------------------------------|---------------------------------------------------------------------------------|----------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|-----------------|-----------|
| NFR-01 | Хранение паролей                   | Пароли пользователей хранятся только в виде Argon2id хэшей                      | Argon2id t=3, m=256MB, p=1 (или stronger)                                              | Unit-тесты конфигурации хэшей; ревью кода; static check конфигов                    | auth            | High      |
| NFR-02 | TTL для access tokens (JWT)        | Access token короткоживущий; refresh token ограничен                            | Access token TTL ≤ 15 min; Refresh TTL ≤ 7 days                                        | Unit/integration тесты; проверка конфигурации env; security review                  | auth / tokens   | High      |
| NFR-03 | Owner-only Authorization           | **Только владелец задания/рутины может редактировать/удалять Assignment/Chore** | 100% операций модификации проверяют owner_id; 0 bypass incidents in tests              | Автотесты (unit+integration) и policy tests; e2e: попытки чужих пользователей → 403 | api / authz     | High      |
| NFR-04 | Логирование и маскирование PII     | Логи не содержат открытых паролей/PII; correlation_id присутствует              | 100% endpoints: no raw password/email in logs; correlation_id present in ≥90% requests | Лог-скан (grep) в CI; контракт для логов; ручной audit                              | logging         | Medium    |
| NFR-05 | Время отклика — ключевые эндпоинты | Сервис должен отвечать быстро под адекватной нагрузкой                          | p95 **GET /stats** ≤ 200 ms @ 20 RPS stage; p95 **POST /chores** ≤ 300 ms @ 20 RPS     | Нагрузочные тесты (k6/locust) на stage; отчёты в CI                                 | api / perf      | High      |
| NFR-06 | Error rate                         | % ошибок под нагрузкой не должен превышать допустимый уровень                   | 24h rolling error rate (5xx) ≤ 1% при обычной нагрузке; ≤5% при spike                  | Мониторинг (Prometheus/Grafana) + alert; отчет CI нагрузочного теста                | platform / api  | High      |
| NFR-07 | Uptime / Availability              | Минимальная доступность сервиса                                                 | Availability ≥ 99.5% per release window (monthly)                                      | Uptime dashboard; status checks; CI smoke tests                                     | platform        | Medium    |
| NFR-08 | Уязвимости зависимостей            | Критические/High уязвимости должны быть исправлены быстро                       | High/Critical vulnerabilities fixed ≤ 7 дней; Medium ≤ 30 days                         | SCA (dependabot/snyk/gha) report + Issue + MR; CI block on Critical                 | build / deps    | High      |
| NFR-09 | Secrets & rotation                 | Секреты не в репозитории; ротация и TTL для ключей                              | Secrets not in git; root/DB credentials rotated ≤ 90 days; service tokens ≤ 30 days    | Secret-scan (trufflehog) in CI; documented Vault/KMS policy; audit logs             | infra / secrets | Medium    |
| NFR-10 | Backup / Restore                   | Регулярное резервное копирование и проверяемое восстановление                   | RPO ≤ 24h; RTO ≤ 4h (при restore тесте)                                                | Раз в две недели restore test (sandbox) с отчётом                                   | db / infra      | Medium    |
| NFR-11 | Test coverage                      | Критические модули покрыты тестами                                              | Unit & integration coverage ≥ 80% overall; auth & owner checks ≥ 90%                   | Coverage report in CI; gateway fails build if below threshold                       | ci / tests      | Medium    |
| NFR-12 | Rate limiting / brute-force        | Защита от перебора/DoS на аутентификацию и критичные эндпоинты                  | Max 10 login attempts per 15 min per IP/user; global rate limit 100 RPS per instance   | Integration tests; rate-limiter metrics; CI smoke tests                             | auth / infra    | High      |
| NFR-13 | Multi-Factor Authentication (MFA)  | Обязательная двухфакторная аутентификация для всех пользователей                | 100% пользователей должны использовать MFA (TOTP/U2F)                                  | e2e тесты; ZAP baseline; проверка в CI                                              | auth            | High      |
| NFR-14 | Audit DB config                    | Шифрование данных в таблице users                                               | AES-256 для шифрования; TLS для передачи данных                                        | Audit DB config; unit-тесты хэширования                                             | db              | Medium    |
| NFR-15 | Audit log review                   | Логирование всех изменений и проверка аудита действий                           | 100% действий логируются; логи защищены и хранятся в отдельном хранилище               | Policy tests; audit log review; проверка в CI                                       | logging         | Medium    |
| NFR-16 | Resilience test                    | Использование circuit breaker для отказоустойчивости                            | 100% сервисов должны иметь circuit breaker (Hystrix/Resilience4j)                      | Load test; resilience test; проверка в CI                                           | platform        | High      |
| NFR-17 | MR review                          | Изоляция runners в CI/CD и запрет на секреты в репозиториях                     | 100% runners изолированы; секреты не в репозиториях                                    | CI config scan; MR review; проверка в CI                                            | ci / infra      | Medium    |
